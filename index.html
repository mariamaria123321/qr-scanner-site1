<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>NATA QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#2f2c2b">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Montserrat',sans-serif; margin:0; padding:0; background:#2f2c2b; color:#fff; text-align:center; }
    #home,#scan { padding:40px; }
    #scan { display:none; }
    button { padding:14px 28px; font-size:1.2em; background:#f2b828; color:#000; border:none; border-radius:8px; cursor:pointer; margin:10px; }
    button:hover { background:#e0a519; }
    #reader { width:100%;max-width:400px;margin:20px auto; }
    #result { margin-top:20px;font-size:1.2em; }
  </style>
</head>
<body>
  <div id="home">
    <img src="https://storage.googleapis.com/glide-prod.appspot.com/uploads-v2/3LlbgZJWVq2XsrF6zL5n/pub/IjuCDlcsAr7bKTubWUwd.png"
         alt="NATA QR Logo" style="max-width:90%;margin-bottom:30px;"><br>
    <button onclick="start()">Scan QR Code</button>
  </div>

  <div id="scan">
    <div id="reader"></div>
    <p id="result"></p>
    <button onclick="restart()">Scan Again</button>
    <button onclick="back()">Home</button>
  </div>

  <script>
    const proxyURL = '/.netlify/functions/proxy-qr';
    let scanner;

    function start() {
      document.getElementById('home').style.display = 'none';
      document.getElementById('scan').style.display = 'block';
      document.getElementById('result').innerText = '';
      scanner = new Html5Qrcode('reader');
      scanner.start(
        { facingMode: 'environment' }, 
        { fps: 10, qrbox: 300 },
        qr => {
          scanner.stop().then(() => send(qr));
        },
        _ => {}
      );
    }

    function send(qr) {
      fetch(proxyURL, {
        method: 'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ qrData: qr })
      })
      .then(r => r.json())
      .then(json => {
        if (json.status === 'ok') {
          document.getElementById('result').innerText = `Scanned: ${qr}`;
        } else {
          document.getElementById('result').innerText = `Error: ${json.message || 'unknown'}`;
        }
      })
      .catch(() => {
        document.getElementById('result').innerText = 'Network/server error.';
      });
    }

    function restart() {
      document.getElementById('result').innerText = '';
      start();
    }

    function back() {
      scanner.stop().then(() => {
        document.getElementById('scan').style.display = 'none';
        document.getElementById('home').style.display = 'block';
      });
    }
  </script>
</body>
</html>
